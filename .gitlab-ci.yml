variables:
  GIT_SUBMODULE_STRATEGY: recursive
  SC_PROJECT_PATH: $CI_PROJECT_DIR/ScreenControl_Unity
  TF_PROJECT_PATH: $CI_PROJECT_DIR/TouchFree
  UNITY_HUB: "C:/Program Files/Unity Hub/Unity Hub.exe"

  SC_CFW_PATH: $CI_PROJECT_DIR/ScreenControl_Web
  SC_CFU_PATH: $CI_PROJECT_DIR/ScreenControl_Unity/Assets/ScreenControl/Client
  SC_SRV_PATH: $CI_PROJECT_DIR/ScreenControl_Unity/Assets/ScreenControl/Service

  SC_CFU_VERSION: 'alpha5'
  SC_CFW_VERSION: 'alpha5'
  SC_SRV_VERSION: 'alpha5'
  TOUCHFREE_VERSION: 'alpha5'

  SC_API_VERSION: '1.0.3'

stages:
  - build
  - test
  - package
  - installer

SC_Client::Unity::build:
  stage: build
  when: always
  script:
    # Get Unity version and changeset from the project.
    - $line = Get-Content  $SC_PROJECT_PATH/ProjectSettings/ProjectVersion.txt | Select -Index 1
    - $UNITY_VERSION = $line -Split " " | Select -Index 1
    - $UNITY_CHANGESET = $line -Match '\((.+)\)' | ForEach-Object { $Matches[1] }
    # Check whether the required Unity version is installed. If not, install it.
    - Start-Process -Wait -RedirectStandardOutput "tmp.txt" -FilePath "$UNITY_HUB" -ArgumentList "-- --headless editors --installed"
    - Get-Content "tmp.txt"
    - Start-Process -Wait -RedirectStandardOutput "tmp.txt" -FilePath "$UNITY_HUB" -ArgumentList "-- --headless install-path --set C:/Unity"
    - Get-Content "tmp.txt"
    - if (-not (Test-Path "C:/Unity/$UNITY_VERSION")) { Start-Process -Wait -RedirectStandardOutput "tmp.txt" -FilePath "$UNITY_HUB" -ArgumentList "-- --headless install --version $UNITY_VERSION --changeset $UNITY_CHANGESET" }
    - Get-Content "tmp.txt"

    - $UNITY_EXE = "C:/Unity/$UNITY_VERSION/Editor/Unity.exe"
    - echo "$UNITY_EXE"

    # Update Version.txt with latest information before packaging
    - python ./Scripts/UpdateVersionFile.py --path ${env:SC_CFU_PATH}/Version.txt --swVer ${env:SC_CFU_VERSION} --apiVer ${env:SC_API_VERSION} --ref ${env:CI_COMMIT_SHORT_SHA}
    # Copy Version.txt to Client_Release folder
    - if (Test-Path -Path "./Client_Release") {
        Remove-Item -LiteralPath ./Client_Release -Force -Recurse
        Remove-Item -LiteralPath ./Client_Release -Force -Recurse
      }
    - mkdir ./Client_Release
    - cp ${env:CI_PROJECT_DIR}/ScreenControl_Unity/Assets/ScreenControl/Client/Version.txt ./Client_Release

    # Package Client
    - cd ./Scripts
    - "& ./package_unity_client.bat $UNITY_EXE"
  artifacts:
    name: "Client_for_Unity_Build_${env:CI_COMMIT_SHORT_SHA}"
    paths:
      - ./Client_Release/*
      - ./Client_for_Unity_package.log
    expire_in: 2 weeks
    when: always
  tags:
    - unity
    - win10

SC_Client::Web::build:
  stage: build
  when: always
  script:
    # Update Version.txt with latest information before packaging
    - python ./Scripts/UpdateVersionFile.py --path ${env:SC_CFW_PATH}/Version.txt --swVer ${env:SC_CFW_VERSION} --apiVer ${env:SC_API_VERSION} --ref ${env:CI_COMMIT_SHORT_SHA}
    # Build Client
    - cd ${env:SC_CFW_PATH}
    - npm i
    - ./node_modules/.bin/gulp build
    # Clean last build
    - cd ${env:CI_PROJECT_DIR}
    - if (Test-Path -Path "./Client_Release") {
        Remove-Item -LiteralPath ./Client_Release -Force -Recurse
        Remove-Item -LiteralPath ./Client_Release -Force -Recurse
      }
    # Package Client
    - mkdir ./Client_Release
    - cp ${env:SC_CFW_PATH}/Version.txt ./Client_Release
    - cp -r ${env:SC_CFW_PATH}/dist ./Client_Release
    - cp -r ${env:SC_CFW_PATH}/examples ./Client_Release
  artifacts:
    name: "Client_for_Web_Build_${env:CI_COMMIT_SHORT_SHA}"
    paths:
      - ./Client_Release/*
    expire_in: 2 weeks
    when: always
  tags:
    - unity
    - win10

SC_Client::Docs::build:
  stage: build
  when: always
  image: registry.ultrahaptics.com/apps/infrastructure/docker-naturaldocs:main
  script:
    - mono "/opt/Natural Docs/NaturalDocs.exe" $CI_PROJECT_DIR/ScreenControl_Unity/NaturalDocs_Config
    - mono "/opt/Natural Docs/NaturalDocs.exe" $CI_PROJECT_DIR/ScreenControl_Web/NaturalDocs_Config
  artifacts:
    name: "ScreenControl_Documentation"
    paths:
    - ./Documentation/*
    expire_in: 2 weeks
    when: always
  tags:
    - docker

SC_Service::Wrapper::build:
  stage: build
  when: always
  script:
    - MSBuild.exe $CI_PROJECT_DIR/ScreenControl_Service_Utilities/SC_ServiceWrapper/SC_ServiceWrapper.sln /p:Configuration=Release
    # Move the built wrapper to the root directory
    - mkdir ./SC_Wrapper_Build
    - cp -r $CI_PROJECT_DIR/ScreenControl_Service_Utilities/SC_ServiceWrapper/SC_ServiceWrapper/bin/Release/* ./SC_Wrapper_Build

    # Sign the executable with the UltraLeap certificate
    - $cert=Get-ChildItem -Path Cert:\LocalMachine\My -CodeSigningCert
    - Set-AuthenticodeSignature -FilePath $CI_PROJECT_DIR/SC_Wrapper_Build/SC_ServiceWrapper.exe -TimestampServer 'http://timestamp.comodoca.com/authenticode' -Certificate $cert
  artifacts:
    name: "SC_Service_Wrapper"
    paths:
    - ./SC_Wrapper_Build/**
    expire_in: 2 weeks
    when: always
  tags:
    - unity
    - win10

SC_Service::Tray::build:
  stage: build
  when: always
  script:
    - MSBuild.exe $CI_PROJECT_DIR/ScreenControl_Service_Utilities/SC_ServiceUITray/SC_ServiceUITray.sln /p:Configuration=Release
    # Move the built tray app to the root directory
    - mkdir ./SC_Tray_Build
    - cp -r $CI_PROJECT_DIR/ScreenControl_Service_Utilities/SC_ServiceUITray/SC_ServiceUITray/bin/Release/* ./SC_Tray_Build

    # Sign the executable with the UltraLeap certificate
    - $cert=Get-ChildItem -Path Cert:\LocalMachine\My -CodeSigningCert
    - Set-AuthenticodeSignature -FilePath $CI_PROJECT_DIR/SC_Tray_Build/SC_ServiceUITray.exe -TimestampServer 'http://timestamp.comodoca.com/authenticode' -Certificate $cert
  artifacts:
    name: "SC_Service_Tray"
    paths:
    - ./SC_Tray_Build/**
    expire_in: 2 weeks
    when: always
  tags:
    - unity
    - win10

SC_Service::build:
  stage: build
  when: always
  script:
    # Get Unity version and changeset from the project.
    - $line = Get-Content  $SC_PROJECT_PATH/ProjectSettings/ProjectVersion.txt | Select -Index 1
    - $UNITY_VERSION = $line -Split " " | Select -Index 1
    - $UNITY_CHANGESET = $line -Match '\((.+)\)' | ForEach-Object { $Matches[1] }
    # Check whether the required Unity version is installed. If not, install it.
    - Start-Process -Wait -RedirectStandardOutput "tmp.txt" -FilePath "$UNITY_HUB" -ArgumentList "-- --headless editors --installed"
    - Get-Content "tmp.txt"
    - Start-Process -Wait -RedirectStandardOutput "tmp.txt" -FilePath "$UNITY_HUB" -ArgumentList "-- --headless install-path --set C:/Unity"
    - Get-Content "tmp.txt"
    - if (-not (Test-Path "C:/Unity/$UNITY_VERSION")) { Start-Process -Wait -RedirectStandardOutput "tmp.txt" -FilePath "$UNITY_HUB" -ArgumentList "-- --headless install --version $UNITY_VERSION --changeset $UNITY_CHANGESET" }
    - Get-Content "tmp.txt"

    - $UNITY_EXE = "C:/Unity/$UNITY_VERSION/Editor/Unity.exe"
    - echo "$UNITY_EXE"

    # Update Version.txt with latest information before packaging
    - python ./Scripts/UpdateVersionFile.py --path ${env:SC_SRV_PATH}/Version.txt --swVer ${env:SC_SRV_VERSION} --apiVer ${env:SC_API_VERSION} --ref ${env:CI_COMMIT_SHORT_SHA}
    - mkdir $CI_PROJECT_DIR/Build
    - cp ${env:SC_SRV_PATH}/Version.txt $CI_PROJECT_DIR/Build
    - mkdir $CI_PROJECT_DIR/UIBuild
    - cp ${env:SC_SRV_PATH}/Version.txt $CI_PROJECT_DIR/UIBuild

    # Update ProjectSettings file with correct version & build service
    - cd ./Scripts
    - python ./UpdateUnityProjVer.py --path ../ScreenControl_Unity/ProjectSettings/ProjectSettings.asset --ver ${env:SC_SRV_VERSION}
    - "& ./build_service.bat $UNITY_EXE"
    - python ./UpdateBuildSettings_Service.py --path ../ScreenControl_Unity/ProjectSettings/EditorBuildSettings.asset
    - "& ./build_serviceUI.bat $UNITY_EXE"

    # Sign the executable with the UltraLeap certificate
    - $cert=Get-ChildItem -Path Cert:\LocalMachine\My -CodeSigningCert
    - ls $CI_PROJECT_DIR/Build
    - Set-AuthenticodeSignature -FilePath $CI_PROJECT_DIR/Build/ScreenControlService.exe -TimestampServer 'http://timestamp.comodoca.com/authenticode' -Certificate $cert

    - $cert=Get-ChildItem -Path Cert:\LocalMachine\My -CodeSigningCert
    - ls $CI_PROJECT_DIR/UIBuild
    - Set-AuthenticodeSignature -FilePath $CI_PROJECT_DIR/UIBuild/ScreenControlServiceUI.exe -TimestampServer 'http://timestamp.comodoca.com/authenticode' -Certificate $cert
  artifacts:
    name: "Screen_Control_Service_${env:SC_SRV_VERSION}_${env:CI_COMMIT_SHORT_SHA}"
    paths:
    - Build/**
    - UIBuild/**
    - ./Unity.log
    expire_in: 2 weeks
    when: always
  tags:
    - unity
    - win10

TouchFree::build:
  stage: build
  when: always
  script:
    # Get Unity version and changeset from the project.
    - $line = Get-Content  $TF_PROJECT_PATH/ProjectSettings/ProjectVersion.txt | Select -Index 1
    - $UNITY_VERSION = $line -Split " " | Select -Index 1
    - $UNITY_CHANGESET = $line -Match '\((.+)\)' | ForEach-Object { $Matches[1] }

    # Check whether the required Unity version is installed. If not, install it.
    - Start-Process -Wait -RedirectStandardOutput "tmp.txt" -FilePath "$UNITY_HUB" -ArgumentList "-- --headless editors --installed"
    - Get-Content "tmp.txt"
    - Start-Process -Wait -RedirectStandardOutput "tmp.txt" -FilePath "$UNITY_HUB" -ArgumentList "-- --headless install-path --set C:/Unity"
    - Get-Content "tmp.txt"
    - if (-not (Test-Path "C:/Unity/$UNITY_VERSION")) { Start-Process -Wait -RedirectStandardOutput "tmp.txt" -FilePath "$UNITY_HUB" -ArgumentList "-- --headless install --version $UNITY_VERSION --changeset $UNITY_CHANGESET" }
    - Get-Content "tmp.txt"

    - $UNITY_EXE = "C:/Unity/$UNITY_VERSION/Editor/Unity.exe"
    - echo "$UNITY_EXE"

    # Update Version.txt with latest information before packaging
    - python ./Scripts/UpdateVersionFile.py --path ${env:TF_PROJECT_PATH}/Assets/TouchFree/Version.txt --apiVer ${env:SC_API_VERSION} --swVer ${env:TOUCHFREE_VERSION} --ref ${env:CI_COMMIT_SHORT_SHA}

    # Copy Version.txt to Client_Release folder
    - if (Test-Path -Path "./TouchFree_Build") {
        Remove-Item -LiteralPath ./TouchFree_Build -Force -Recurse
        Remove-Item -LiteralPath ./TouchFree_Build -Force -Recurse
      }
    - mkdir ./TouchFree_Build
    - cp ${env:CI_PROJECT_DIR}/TouchFree/Assets/TouchFree/Version.txt ./Client_Release

    # Build TouchFree
    - cd ./Scripts
    - python ./UpdateUnityProjVer.py --path ../TouchFree/ProjectSettings/ProjectSettings.asset --ver ${env:SC_SRV_VERSION}
    - "& ./build_touchfree.bat $UNITY_EXE"

    # Sign the executable with the UltraLeap certificate
    - $cert=Get-ChildItem -Path Cert:\LocalMachine\My -CodeSigningCert
    - ls $CI_PROJECT_DIR/Build
    - Set-AuthenticodeSignature -FilePath $CI_PROJECT_DIR/TouchFree_Build/TouchFree.exe -TimestampServer 'http://timestamp.comodoca.com/authenticode' -Certificate $cert

  artifacts:
    name: "TouchFree_Build_${env:CI_COMMIT_SHORT_SHA}"
    paths:
      - ./Build/*
      - ./TouchFree_build.log
    expire_in: 2 weeks
    when: always
  tags:
    - unity
    - win10

SC_Service::test:
  stage: test

  dependencies:
    - SC_Service::build
  needs: ["SC_Service::build"]

  script:
    - cd ./Testing/ServiceSocketTests/
    - npm install
    - ./node_modules/.bin/gulp build_machine_run

  artifacts:
    name: test_results
    paths:
      - ./Testing/ServiceSocketTests/results/**
      - ./Testing/ServiceSocketTests/PUT_TEST_BUILD_IN_HERE/**
    reports:
      junit: ./Testing/ServiceSocketTests/results/test_results.xml
    when: always
  tags:
    - unity
    - win10

SC_Client::Web::package:
  stage: package
  image: alpine:3.13
  dependencies:
    - SC_Client::Web::build
    - SC_Client::Docs::build
  needs: [
    "SC_Client::Web::build",
    "SC_Client::Docs::build"
  ]
  script:
    - mkdir ./Client_Package/
    - cp -r ./Client_Release/* ./Client_Package/
    - cp -r "./Documentation/Client for Web/" ./Client_Package/Documentation/
  artifacts:
    name: "Screen_Control_Client_for_Web_${SC_CFW_VERSION}_${CI_COMMIT_SHORT_SHA}"
    paths:
      - ./Client_Package/*
    expire_in: 2 weeks
    when: always
  tags:
    - docker

SC_Client::Unity::package:
  stage: package
  image: alpine:3.13
  dependencies:
    - SC_Client::Unity::build
    - SC_Client::Docs::build
  needs: [
    "SC_Client::Unity::build",
    "SC_Client::Docs::build"
  ]
  script:
    - mkdir ./Client_Package/
    - cp -r ./Client_Release/* ./Client_Package/
    - cp -r "./Documentation/Client for Unity/" ./Client_Package/Documentation/
  artifacts:
    name: "Screen_Control_Client_for_Unity_${SC_CFU_VERSION}_${CI_COMMIT_SHORT_SHA}"
    paths:
      - ./Client_Package/*
    expire_in: 2 weeks
    when: always
  tags:
    - docker

SC_Service::package:
  stage: package
  dependencies:
    - SC_Service::build
    - SC_Service::Wrapper::build
    - SC_Service::Tray::build
  needs: [
    "SC_Service::build",
    "SC_Service::Wrapper::build",
    "SC_Service::Tray::build"
  ]
  script:
    # Package ScreenControl up neatly
    - mkdir ./Service_Package/
    - mkdir ./Service_Package/Licenses/
    - mkdir ./Service_Package/Service/
    - mkdir ./Service_Package/ServiceUI/
    - mkdir ./Service_Package/Wrapper/
    - mkdir ./Service_Package/Tray/
    - cp -r ./Build/* ./Service_Package/Service/
    - cp -r ./UIBuild/* ./Service_Package/ServiceUI/
    - cp -r ./SC_Wrapper_Build/* ./Service_Package/Wrapper/
    - cp -r ./SC_Tray_Build/* ./Service_Package/Tray/
    - cp -r ./Third_Party_Licenses/* ./Service_Package/Licenses/

    # Run innosetup
    - cd ./Scripts/
    - "& ./compile_installer.bat $CI_PROJECT_DIR/ScreenControl_Service_Utilities/Installer/SC_Service_Installer.iss"

    # Sign the installer with the UltraLeap certificate
    - $cert=Get-ChildItem -Path Cert:\LocalMachine\My -CodeSigningCert
    - ls $CI_PROJECT_DIR/Build
    - Set-AuthenticodeSignature -FilePath "$CI_PROJECT_DIR/Installer_Build/ScreenControl_Service_1.0.0_${SC_SRV_VERSION}_Installer.exe" -TimestampServer 'http://timestamp.comodoca.com/authenticode' -Certificate $cert
  artifacts:
    name: "ScreenControl_Service_${SC_SRV_VERSION}_${CI_COMMIT_SHORT_SHA}"
    paths:
      - ./Installer_Build/*.exe
    expire_in: 2 weeks
    when: always
  tags:
    - unity
    - win10
